<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ sanitized_name }} - Reproducci√≥n</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- CSS del reproductor -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/play/play.css') }}?v={{ range(1, 10000) | random }}">
</head>
<body>
    <div class="container">
        <!-- Secci√≥n del reproductor -->
        <section class="video-section">
            <h1>{{ sanitized_name }}</h1>
            <div class="underline"></div>
            
            <div class="video-wrapper">
                <video controls>
                    <source src="/stream/{{ filename }}" type="video/mp4">
                    Tu navegador no soporta este formato.
                </video>
                
                <div class="video-controls">
                    <a href="/download/{{ filename }}" class="download-btn">‚¨áÔ∏è Descargar pel√≠cula</a>
                </div>
            </div>
        </section>

        <!-- Secci√≥n de informaci√≥n de la pel√≠cula (se carga de forma as√≠ncrona) -->
        <section class="movie-info" id="movie-info-section" style="display: none;">
            <div class="loading-info">
                <p>üìΩÔ∏è Cargando informaci√≥n de la pel√≠cula...</p>
            </div>
        </section>

        <!-- Mensaje si no hay informaci√≥n -->
        <div class="no-info" id="no-movie-info" style="display: none;">
            <p>üé¨ No se encontr√≥ informaci√≥n adicional para esta pel√≠cula</p>
            <p class="no-info-sub">Puedes seguir viendo la pel√≠cula sin problemas</p>
        </div>
    </div>

    <!-- Datos de la pel√≠cula para carga as√≠ncrona -->
    <div id="movie-data" 
         data-title="{{ clean_title | default('') }}" 
         data-year="{{ year if year else '' }}"
         style="display: none;">
    </div>
    
    <script src="{{ url_for('static', filename='js/play/play.js') }}?v={{ range(1, 10000) | random }}" defer></script>
    
    <script>
    // Cargar metadatos de forma as√≠ncrona
    (function() {
        var movieDataEl = document.getElementById('movie-data');
        var cleanTitle = movieDataEl ? movieDataEl.getAttribute('data-title') : '';
        var movieYear = movieDataEl ? movieDataEl.getAttribute('data-year') : '';
        
        if (cleanTitle) {
            var url = '/api/movie/metadata?title=' + encodeURIComponent(cleanTitle);
            if (movieYear) {
                url += '&year=' + movieYear;
            }
            
            fetch(url)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta');
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.title) {
                        mostrarMovieInfo(data);
                    } else {
                        mostrarNoInfo();
                    }
                })
                .catch(function(error) {
                    console.log('No se pudieron cargar los metadatos:', error);
                    mostrarNoInfo();
                });
        } else {
            mostrarNoInfo();
        }
        
        function mostrarMovieInfo(data) {
            var section = document.getElementById('movie-info-section');
            var noInfo = document.getElementById('no-movie-info');
            
            if (!section) return;
            
            var html = '';
            
            html += '<div class="info-header">';
            
            if (data.poster) {
                html += '<div class="movie-poster">';
                html += '<img src="' + data.poster[0] + '" alt="' + data.title + '" onerror="this.onerror=null; this.src=\'' + data.poster[1] + '\';" />';
                html += '</div>';
            } else {
                html += '<div class="movie-poster-placeholder"><span>üé¨<br>Sin imagen</span></div>';
            }
            
            html += '<div class="movie-header">';
            html += '<h2>' + data.title + (data.year ? ' <span class="movie-year">(' + data.year + ')</span></h2>' : '</h2>');
            
            html += '<div class="movie-meta">';
            if (data.runtime && data.runtime !== 'N/A') {
                html += '<span class="meta-item">‚è±Ô∏è ' + data.runtime + '</span>';
            }
            if (data.released && data.released !== 'N/A') {
                html += '<span class="meta-item">üìÖ ' + data.released + '</span>';
            }
            if (data.imdb_rating && data.imdb_rating !== 'N/A') {
                html += '<span class="meta-item rating">‚≠ê ' + data.imdb_rating + '/10</span>';
            }
            html += '</div>';
            
            if (data.genres && data.genres.length > 0) {
                html += '<div class="genres">';
                data.genres.forEach(function(genre) {
                    html += '<span class="genre-tag">' + genre + '</span>';
                });
                html += '</div>';
            }
            
            html += '</div></div>';
            
            if (data.plot && data.plot !== 'N/A') {
                html += '<div class="plot">' + data.plot + '</div>';
            }
            
            html += '<div class="details-grid">';
            if (data.director && data.director !== 'N/A') {
                html += '<div class="detail-card"><div class="detail-label">Director</div><div class="detail-value">' + data.director + '</div></div>';
            }
            if (data.writer && data.writer !== 'N/A') {
                html += '<div class="detail-card"><div class="detail-label">Guionista</div><div class="detail-value">' + data.writer + '</div></div>';
            }
            if (data.country && data.country !== 'N/A') {
                html += '<div class="detail-card"><div class="detail-label">Pa√≠s</div><div class="detail-value">' + data.country + '</div></div>';
            }
            if (data.language && data.language !== 'N/A') {
                html += '<div class="detail-card"><div class="detail-label">Idioma</div><div class="detail-value">' + data.language + '</div></div>';
            }
            if (data.box_office && data.box_office !== 'N/A') {
                html += '<div class="detail-card"><div class="detail-label">Taquilla</div><div class="detail-value">' + data.box_office + '</div></div>';
            }
            if (data.awards && data.awards !== 'N/A') {
                html += '<div class="detail-card"><div class="detail-label">Premios</div><div class="detail-value">' + data.awards + '</div></div>';
            }
            html += '</div>';
            
            if (data.ratings && data.ratings.length > 0) {
                html += '<div class="ratings">';
                data.ratings.forEach(function(rating) {
                    var parts = rating.split(' ');
                    html += '<div class="rating-card"><div class="rating-source">' + parts[0] + '</div><div class="rating-value">' + (parts[1] || '') + '</div></div>';
                });
                html += '</div>';
            }
            
            if (data.cast && data.cast.length > 0) {
                html += '<div class="cast-section"><h3>Reparto principal</h3><div class="cast-list">';
                data.cast.forEach(function(actor) {
                    html += '<span class="cast-item">' + actor + '</span>';
                });
                html += '</div></div>';
            }
            
            section.innerHTML = html;
            section.style.display = 'block';
            if (noInfo) noInfo.style.display = 'none';
        }
        
        function mostrarNoInfo() {
            var section = document.getElementById('movie-info-section');
            var noInfo = document.getElementById('no-movie-info');
            
            if (section) section.style.display = 'none';
            if (noInfo) noInfo.style.display = 'block';
        }
    })();
    </script>
</body>
</html>
